#!/bin/make

##################################################
# Make config
##################################################
.DELETE_ON_ERROR:
.EXPORT_ALL_VARIABLES:
.SECONDEXPANSION:
SHELL					 := IN_BASH
.DEFAULT_GOAL	 := all

##################################################
# App description
##################################################
pkg_name							= IN_PKG_NAME
pkg_tarname						= IN_PKG_TARNAME
pkg_distname					= IN_PKG_DISTNAME
pkg_version						= IN_PKG_VERSION
pkg_vversion					= IN_PKG_VVERSION
pkg_homepage					= IN_PKG_HOMEPAGE
pkg_bugreport					= IN_PKG_BUGREPORT
pkg_repository				= IN_PKG_REPOSITORY

##################################################
# Program name transformation
##################################################
program_name					= IN_PROGRAM_NAME
program_vname					= IN_PROGRAM_VNAME

##################################################
# Build directories
##################################################
buildir								= IN_BUILDIR
buildir_abs						= IN_BUILDIR_ABS
srcdir_top						= IN_SRCDIR
srcdir_top_abs				= IN_SRCDIR_ABS
srcdir								= $(srcdir_top)/src
srcdir_abs						= $(srcdir_top_abs)/src

##################################################
# Installation directories
##################################################
# gnu prefix directories
prefix								= IN_PREFIX
exec_prefix						= IN_EXEC_PREFIX
bindir								= IN_BINDIR
sbindir								= IN_SBINDIR
libexecdir						= IN_LIBEXECDIR
datarootdir						= IN_DATAROOTDIR
datadir								= IN_DATADIR
sysconfdir						= IN_SYSCONFDIR
sharedstatedir				= IN_SHAREDSTATEDIR
localstatedir					= IN_LOCALSTATEDIR
runstatedir						= IN_RUNSTATEDIR
includedir						= IN_INCLUDEDIR
oldincludedir					= IN_OLDINCLUDEDIR
docdir								= IN_DOCDIR
infodir								= IN_INFODIR
htmldir								= IN_HTMLDIR
dvidir								= IN_DVIDIR
pdfdir								= IN_PDFDIR
psdir									= IN_PSDIR
libdir								= IN_LIBDIR
localedir							= IN_LOCALEDIR
mandir								= IN_MANDIR
# Derived directories
tmpdir								= IN_TMPDIR
tmpdir_persistent			= IN_TMPDIR_PERSISTENT
statedir							= IN_STATEDIR
cachedir							= IN_CACHEDIR
logdir								= IN_LOGDIR
spooldir							= IN_SPOOLDIR
lockdir								= IN_LOCKDIR
desktopdir						= IN_DESKTOPDIR
icondir								= IN_ICONDIR
metainfodir						=	IN_METAINFODIR

##################################################
# Tools
##################################################
ssh										= IN_SSH
scp										= IN_SCP
chmod									= IN_CHMOD
chown									= IN_CHOWN
jq										= IN_JQ
m4										= IN_M4
cp										= IN_CP
rm										= IN_RM
cat										= IN_CAT
crond									=	IN_CROND
bumpve								= $(srcdir_top)/scripts/bumpve.sh
release								= $(srcdir_top)/scripts/release.sh

##################################################
# Important files
##################################################
macrosfile   = $(srcdir_top)/config.macros.m4
configfile	 = $(srcdir_top)/configure
releasefile	 = $(srcdir_top)/RELEASE

# Options
PROXY_HOSTNAME				 = IN_PROXY_HOSTNAME
PROXY_PORT						 = IN_PROXY_PORT
PROXY_HOSTSFILE				 = IN_PROXY_HOSTSFILE
PROXY_LOGIN_USERNAME	 = IN_PROXY_LOGIN_USERNAME
PUSHIP_CRON_LOGFILE		 = IN_PUSHIP_CRON_LOGFILE
PUSHIP_CRON_RUNTIME		 = IN_PUSHIP_CRON_RUNTIME
AUTOBAK_CRON_LOGFILE	 = IN_AUTOBAK_CRON_LOGFILE
AUTOBAK_CRON_RUNTIME	 = IN_AUTOBAK_CRON_RUNTIME
HOST_BACKUP_HOSTNAME   = IN_HOST_BACKUP_HOSTNAME
HOST_BACKUP_ALIASES    = IN_HOST_BACKUP_ALIASES

##################################################
# Default target
##################################################
all: build

##################################################
# Build
##################################################
build: crontab puship edithosts

puship: $(srcdir)/puship.sh
	$(m4) $(macrosfile) \
	-DIN_EDITHOSTS=$(bindir)/edithosts \
	$< > $@
	$(chmod) --verbose 755 $@

edithosts: $(srcdir)/edithosts.sh
	cat $< > $@
	$(chmod) --verbose 755 $@

define TEMPLATE_MSG
# This file has been automatically generated by Make.
#
# Contained within are 4 cron job scheduling example configurations
# for the programs:
#
#   - autobak
#   - puship
#
# The user is expected to either copy verbatim an example
# configuration to a cron config file or use crontab -e
#
# A scheduled job is represented by a line in one of the many config
# files read by cron.
#
# 2 of which are:
#
#   - /etc/crontab
#      minute hour day-of-month month day-of-week USER COMMAND
#   - /var/spool/cron/<user> (through crontab -e)
#      minute hour day-of-month month day-of-week COMMAND
#
# A job scheduling configuration intended for /etc/crontab cannot be
# shared verbatim to crontab -e because of the existence of the extra
# USER field.
endef

define PUSHIP_CRON_CONFIG
# puship config -> /etc/crontab
$(PUSHIP_CRON_RUNTIME) root $(bindir)/puship >> $(PUSHIP_CRON_LOGFILE) 2>&1

# puship config -> crontab -e
$(PUSHIP_CRON_RUNTIME) $(bindir)/puship >> $(PUSHIP_CRON_LOGFILE) 2>&1
endef

define AUTOBAK_CRON_CONFIG
# autobak config -> /etc/crontab
$(AUTOBAK_CRON_RUNTIME) root $(bindir)/autobak >> $(AUTOBAK_CRON_LOGFILE) 2>&1

# autobak config -> crontab -e
$(AUTOBAK_CRON_RUNTIME) $(bindir)/autobak >> $(AUTOBAK_CRON_LOGFILE) 2>&1
endef


crontab: $(srcdir)/crontab.conf
	$(m4) -DTEMPLATE_MSG="$${TEMPLATE_MSG}" \
	-DPUSHIP_CRON_CONFIG="$${PUSHIP_CRON_CONFIG}" \
	-DAUTOBAK_CRON_CONFIG="$${AUTOBAK_CRON_CONFIG}" \
	$< > $@
	$(chmod) --verbose 644 $@

##################################################
# Release
##################################################
release:
	$(release)

##################################################
# Distribute
##################################################
dist: archive?=zip
dist: dist.$$(archive)

##################################################
# Package
##################################################
package: archive?=zip
package: package.$$(archive)

##################################################
# Install
##################################################
install:

##################################################
# Uninstall
##################################################
uninstall:

##################################################
# Update
##################################################
update:

##################################################
# clean
##################################################
clean:
	-rm -f *.tar.gz
	-rm -f $(program_name)
	-rm -f edihosts
	-rm -f puship
	-rm -f crontab

##################################################
# distclean
##################################################
distclean: clean
	-rm -f *.log
	-rm -f .#*
	-rm -f config.*
	-rm -f Makefile

##################################################
# misc
##################################################
.DEFAULT:
	@if [ ! -f "$<" ]; then echo "Missing file -> $${file:-$<}"; exit 1; fi

##################################################
# directories
##################################################

##################################################
# help
##################################################
help:
	@cat ./Makefile | grep -i --color=auto 'phony' | cut -d ' ' -f2- | tail --lines=+3

# Software development
.PHONY: run # Read dotenvfile and run $target or tmp/scratch.js
.PHONY: build # Build application
.PHONY: test # Test application
# Software distribution
.PHONY: release # Create a new version
.PHONY: dist # Distribute source tree
.PHONY: package # Distribute build
# Software package
.PHONY: install # Install package
.PHONY: uninstall # Uninstall package
.PHONY: update # Update package
# Cleaning
.PHONY: clean # Remove files created by ./make
.PHONY: distclean # Remove files created by ./configure
# Misc
.PHONY: help # Display a short description about each Makefile target's function
.PHONY: dotenv # Write environment into .env
.PHONY: all # Default target
